<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/1523d962df.js" crossorigin="anonymous"></script>

    <script type="module" src="js/pdf.js"></script>
    <script type="module" src="js/dyr.js"></script>
    <script type="module" src="js/colour.js"></script>
    <title>Dyrebasen - Mine dyr</title>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">
        <div class="container-fluid">
          <a class="navbar-brand" href="minedyr.html">DYREBASEN</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="collapsibleNavbar">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link active" href="minedyr.html">Mine kaniner</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="regdyr.html">Registrer ny kanin</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="stamtavle.html">Stamtavle</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="minbruker.html">Min bruker</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    
    <!-- Edit Modal -->
    <div class="modal fade" id="editDyrModal" tabindex="-1" aria-labelledby="editDyrModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDyrModalLabel">Rediger kanin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <form>
                            <div class="row">
                                <div class="col">
                                    <label for="inpRegNr" class="form-label">Reg.nr:</label><br>
                                    <input id="inpRegNr" type="number" class="form-control" /><br>
                                </div>
                                <div class="col">
                                    <label for="inpVø" class="form-label">V.Ø:</label>
                                    <input id="inpVø" type="text" class="form-control" /><br>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
    
                                    <label for="inpFdato" class="form-label">Fødselsdato:</label>
                                    <input id="inpFdato" type="date"  class="form-control"/><br>
                            
                                </div>
                                <div class="col">
    
                                    <label for="inpKullNr" class="form-label">Kullnummer</label>
                                    <input id="inpKullNr" type="number" class="form-control" /><br>
                            
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                                                
                                    <label for="dropKjønn" class="form-label">Kjønn:</label>
                                    <select id="dropKjønn" class="form-control">
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                    <br>

                                </div>
                                <div class="col">
    
                                    <label for="inpInnavlsgrad" class="form-label">Innavlsgrad:</label>
                                    <input id="inpInnavlsgrad" type="number" class="form-control" min="0" max="100" /><br>
                            
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
    
                                    <label for="inpPoeng" class="form-label">Poeng:</label>
                                    <input id="inpPoeng" type="number" class="form-control" min="0" max="100"/><br>
                            
                                </div>
                                <div class="col">
    
                                    <label for="inpFarge" class="form-label">Farge:</label>
                                    <input class="form-control" list="fargeValg" id="inpFarge" placeholder="Skriv inn en farge...">
                                    <datalist id="fargeValg">
                                    </datalist>
                                    <br>
                            
                                </div>
                           </div>
                            <div class="row">
                                <div class="col">
    
                                    <label for="inpFar" class="form-label">Far:</label>
                                    <input class="form-control" list="valgFar" id="inpFar" placeholder="Finn foreldre (regnr)...">
                                    <datalist id="valgFar">
                                    </datalist>
                                    <br>
                            
                                </div>
                                <div class="col">
    
                                    <label for="inpMor" class="form-label">Mor:</label>
                                    <input class="form-control" list="valgMor" id="inpMor" placeholder="Finn foreldre (regnr)...">
                                    <datalist id="valgMor">
                                    </datalist>
                                    <br>
                            
                                </div>
                           </div>
                            <div class="row">
                                <div class="col">
                                    <label for="inpBilde" class="form-label">Last opp bilde: (ratio: 1x1)</label>
                                    <input class="form-control" type="file" id="inpBilde"><br>
                                </div>
                           </div>
                           <div class="row">
                                <div class="col">
                                    <p id="txtResponse" class="text-center text-danger"></p>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
                <button type="button" id="btnEditAnimal" class="btn btn-primary" data-bs-dismiss="modal">Lagre endringer</button>
                </div>
            </div>
        </div> 
    </div>    
    <!----------- HTML-elements -------------->
    <div class="container">
        <h1 class="text-center m-5 pt-5" >MINE DYR</h1>
        <div class="row justify-content-center mt-3">
            <div class="col-2">
                <select id="dropKey" class="form-control shadow">
                    <option value="regnr">Regnr</option>
                    <option value="vø">V.Ø.</option>
                    <option value="kullnr">Kullnummer</option>
                    <option value="innavlsgrad">Innavlsgrad</option>
                    <option value="poeng">Poeng</option>
                    <option value="farge">Farge</option>
                    <option value="far">Far (id)</option>
                    <option value="mor">Mor (id)</option>
                </select>
            </div>
            <div class="col-1">
                <select id="dropOperator" class="form-control shadow">
                    <option value="=">=</option>
                    <option value=">">></option>
                    <option value="<"><</option>
                    <option value=">=">>=</option>
                    <option value="<="><=</option>
                </select>
            </div>
            <div class="col-2">
                <input id="inpSearch" type="text" class="form-control shadow" placeholder="Søk..." autofocus/>
            </div>
            
            <div class="col-1">
                <button id="btnSearch" class="btn btn-secondary shadow justify-self-start text-light">Søk</button>
            </div>
            <div class="col-1">
                <button id="btnClear" class="btn btn-secondary shadow justify-self-start text-light">Tøm</button>
            </div>
            <div class="row">
                <div class="col">
                    <p id="searchRes"></p>
                </div>
            </div>
        </div>
        <div id="container" class="container mt-4 mx-auto"></div>
        <div class="col text-center mt-5 mb-5">
            <a class="regKanin btn btn-secondary shadow justify-self-center text-light" href="regdyr.html">Registrer ny kanin</a>
        </div>
    </div>

    <footer class="navbar-dark p-4">
        <p style="font-size: small;"> Laget av: <br> Mads Madsen Klepper <br>Dorthe Sofie B. Sletten <br> Kristian Birger Rummelhoff</p>
    </footer>

    

    
    <!------------- JavaScript --------------->
    <script type="module">
        import {getToken, checkToken} from "/js/user.js";
        import {storForbokstav} from "/js/form.js";
        import {dbSearch, activeID, originalInputValues, listAnimals, updateAnimal} from "/js/dyr.js";
        import {generatePDF} from "/js/pdf.js";
        checkToken();
        let loggedInToken = await getToken();
        let container = document.getElementById('container');
        let btnEditAnimal = document.getElementById('btnEditAnimal');
        let testBilde = document.getElementById('testBilde'); 
        
        let inpRegNr = document.getElementById('inpRegNr');
        let inpVø = document.getElementById('inpVø');
        let inpFdato = document.getElementById('inpFdato');
        let inpKullNr = document.getElementById('inpKullNr');
        let dropKjønn = document.getElementById('dropKjønn');
        let inpInnavlsgrad = document.getElementById('inpInnavlsgrad');
        let inpPoeng = document.getElementById('inpPoeng');
        let inpFarge = document.getElementById('inpFarge');
        let fargeValg = document.getElementById('fargeValg')
        let inpFar = document.getElementById('inpFar');
        let valgFar = document.getElementById('valgFar');
        let inpMor = document.getElementById('inpMor');
        let valgMor = document.getElementById('valgMor');
        let inpBilde = document.getElementById('inpBilde');
        let bildeData = null;
        let dropKey = document.getElementById('dropKey');
        let inpSearch = document.getElementById('inpSearch');
        let btnSearch = document.getElementById('btnSearch');
        let dropOperator = document.getElementById('dropOperator');
        let searchRes = document.getElementById('searchRes');
        let btnClear = document.getElementById('btnClear');
        let txtResponse = document.getElementById('txtResponse');

        inpSearch.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
          event.preventDefault();
          document.getElementById("btnSearch").click();
        }
      });

        inpBilde.addEventListener("change", function (evt) {
            let fr = new FileReader();
            fr.addEventListener("load", function (evt) {
                bildeData = fr.result;
            });
            if (inpBilde.files[0].size < 2000000) {
                fr.readAsDataURL(inpBilde.files[0]);
                txtResponse.innerHTML = "";
                btnEditAnimal.disabled = false;
            }else{
                txtResponse.innerHTML = "Filen er for stor. Max 2MB";
                btnEditAnimal.disabled = true;
            }
        })
        /* 
        function loadDropdown() {
            let animalObject = originalInputValues;
            delete(animalObject.bilde);
            delete(animalObject.kjønn);
            delete(animalObject.fdato)
            for (const key in animalObject) {
                let option = document.createElement("option");
                option.value = key;
                option.innerHTML = key; 
                dropKey.appendChild(option)
            }
        } 
        */
        
        listAnimals();

        btnClear.addEventListener('click', async function(){
            inpSearch.value = ""
            await listAnimals();
        });
        dropKey.addEventListener('change', function(evt) {
            let selectedOption = evt.currentTarget.value
            if (selectedOption === "vø" || selectedOption === "farge") {
                dropOperator.hidden = true             
            }else{
                dropOperator.hidden = false  
            }
        })
        btnSearch.addEventListener('click', async function(){
            let key = dropKey.value;
            let searchbar = inpSearch.value;
            let operator = dropOperator.value;
            if (key === "farge") {
                searchbar = storForbokstav(searchbar);
            }
            let filteredList = await dbSearch(key,searchbar,operator);
            if (!filteredList.error) {
                searchRes.hidden = true
                await listAnimals(filteredList);
            }else{
                searchRes.hidden = false
                searchRes.innerHTML = "Noe gikk galt, kunne ikke finne det du søkte på";
            }
        });

        function filterUpdata() {
            let fargeVerdi = storForbokstav(inpFarge.value)
            let updata = {
                did: activeID,
                regnr: inpRegNr.value,
                vø: inpVø.value,
                fdato: inpFdato.value,
                kullnr: inpKullNr.value,
                kjønn: dropKjønn.value,
                innavlsgrad: inpInnavlsgrad.value,
                poeng: inpPoeng.value,
                farge: fargeVerdi,
                far: inpFar.value,
                mor: inpMor.value,
                bilde: bildeData
            }
            for (const key in updata) {
                if (updata[key] === originalInputValues[key] || updata[key] === null) {
                    delete updata[key]
                }
            }
            return updata;
        }
        btnEditAnimal.addEventListener('click', async function (evt) {
            evt.preventDefault();
            if (inpBilde.files.length === 0) {
                bildeData = null;
            }
            let updata = filterUpdata();
            if (Object.keys(updata).length > 1) {
                
                await updateAnimal(updata);
            }else{
                throw "Nothing changed";
            }
            
            
        })

    </script>

    <!---------------- CSS ------------------->
    <style>
    .regKanin{
        width: 50%;
        height: 50px;
        font-size: larger;
    }
    #container {
        display: grid;
        grid-template-columns: 50% 50%;
        grid-template-rows: auto; 
        column-gap: 15px;
        row-gap: 15px;
        width: 100%;
    }
    
    button {
        border-radius: 5px;
    }
    
    button:hover {
        cursor: pointer;
    }

    body {
        background-color: antiquewhite;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    footer{
        margin-top: auto;
        background-color: rgb(194, 192, 192);
        display: block;
    }

    .item1 {grid-area: img;
            width: 125px;
            border-radius: 100px;
            align-self: center;
            justify-self: center;}
    .item2 {grid-area: did;}
    .item3 {grid-area: regNr;
        align-self: center;
            justify-self: center;}
    .item4 {grid-area: vø;}
    .item5 {grid-area: fDato;}
    .item6 {grid-area: kullNr;}
    .item7 {grid-area: kjønn;}
    .item8 {grid-area: innavlsgrad;}
    .item9 {grid-area: poeng;}
    .item10 {grid-area: farge;}
    .item11 {grid-area: far;}
    .item12 {grid-area: mor;}
    .slett {grid-area: slett;
            margin: auto;}
    .rediger {grid-area: rediger;
            margin: auto;}
    .genstam {grid-area: genstam;}
        

    .mineDyr {
        display: grid;
        grid-template-columns: 190px 190px 190px 50px;
        grid-template-rows: 35px 35px 35px 35px 35px 35px;
        grid-template-areas: 
            "img did innavlsgrad slett"
            "img vø poeng rediger"
            "img fDato farge farge"
            "img kullNr far far"
            "img kjønn mor mor"
            "regNr genstam genstam genstam ";
        
        margin: 10px;
        padding: 10px;
        background-color: white;
        margin: auto;
        max-width: 644px;
    }

    @media screen and (max-width: 1400px) {
        #container{
            grid-template-columns: 1fr;
        }
    }

    </style>

    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script type="module" src="js/form.js"></script> <!-- Håndterer alt av forms-->
</body>

</html>
